<!-- Hidden mobile menu elements to prevent Hextra theme main.js errors -->
<div class="mobile-menu-overlay hx-hidden" style="display: none !important;"></div>
<div class="hamburger-menu hx-hidden" style="display: none !important;"><svg></svg></div>
<div class="sidebar-container hx-hidden" style="display: none !important;"></div>

<!-- Chat Bot Widget for Docs Pages -->
<div id="chatbot-widget" x-data="chatbot" @keydown.escape.window="close()">
  <!-- Trigger Button -->
  <button
    @click="open()"
    x-show="!isOpen"
    class="chatbot-trigger fixed bottom-6 right-6 z-[9998] flex items-center gap-2 px-5 py-3 bg-gradient-to-br from-violet-600 to-violet-700 text-white border-none rounded-full font-inherit text-sm font-medium cursor-pointer shadow-[0_4px_14px_rgba(124,58,237,0.4)] transition-all duration-200 hover:-translate-y-0.5 hover:shadow-[0_6px_20px_rgba(124,58,237,0.5)] active:translate-y-0 sm:bottom-4 sm:right-4 sm:px-4 sm:py-2.5 sm:text-[13px]"
    aria-label="Ask AI"
  >
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
    </svg>
    <span>Ask AI</span>
  </button>

  <!-- Chat Dialog Overlay -->
  <div
    x-show="isOpen"
    x-transition
    @click="$event.target === $el && close()"
    class="chatbot-overlay fixed inset-0 z-[9999] flex items-center justify-center bg-black/50 backdrop-blur-sm p-5 sm:p-2.5"
  >
    <div
      @click.stop
      :class="{ 'expanded': isExpanded }"
      class="chatbot-dialog w-full max-w-[700px] h-[50vh] max-h-[90vh] flex flex-col bg-white dark:bg-gray-800 dark:border dark:border-gray-700 rounded-2xl shadow-2xl overflow-hidden transition-[height,transform] duration-300"
    >
      <!-- Header -->
      <div class="chatbot-header flex items-center justify-between px-5 py-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 shrink-0">
        <div class="chatbot-header-title flex items-center gap-2.5 text-[15px] font-semibold text-gray-900 dark:text-gray-50">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-violet-600">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
          <span>Agentgateway assistant</span>
        </div>
        <button
          @click="close()"
          class="chatbot-close flex items-center justify-center w-8 h-8 bg-transparent border-none rounded-lg text-gray-500 cursor-pointer transition-all duration-150 hover:bg-gray-200 hover:text-gray-900 dark:hover:bg-gray-700 dark:hover:text-gray-50"
          aria-label="Close"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <!-- Messages Container -->
      <div
        x-ref="messagesContainer"
        class="chatbot-messages flex-1 overflow-y-auto p-4 flex flex-col gap-5"
      >
        <!-- Welcome Message -->
        <div x-show="messages.length === 0" class="chatbot-welcome text-center py-4 px-5 text-gray-800 dark:text-gray-400 text-sm">
          <p>Ask me anything about agentgateway configuration, features, or usage.</p>
        </div>

        <!-- Messages -->
        <template x-for="(msg, index) in messages" :key="index">
          <div :class="msg.role === 'user' ? 'flex justify-end' : 'flex justify-start'">
            <!-- User Message -->
            <div
              x-show="msg.role === 'user'"
              class="chatbot-message user bg-gradient-to-br from-violet-600 to-violet-700 text-white px-3 py-2 rounded-2xl rounded-br-sm text-sm leading-relaxed font-normal shadow-[0_2px_8px_rgba(124,58,237,0.2)] dark:shadow-[0_2px_8px_rgba(124,58,237,0.3)] mb-1 break-words max-w-[85%]"
              x-text="msg.content"
            ></div>

            <!-- Assistant Message -->
            <div
              x-show="msg.role === 'assistant'"
              class="chatbot-message assistant flex gap-3 items-start pr-3 max-w-[90%]"
            >
              <!-- Avatar -->
              <div
                :class="{ 'loading': msg.isLoading }"
                class="chatbot-avatar shrink-0 w-8 h-8 flex items-center justify-center rounded-lg p-1 relative"
              >
                <img src="/favicon.svg" alt="Agent" class="w-full h-full transition-all duration-200">
              </div>

              <!-- Content -->
              <div class="chatbot-message-content flex-1 min-w-0 max-w-[90%]">
                <!-- Thinking Indicator -->
                <div
                  x-show="msg.isStreaming && showThinking && isLastMessage(index)"
                  class="chatbot-thinking mb-1"
                >
                  <div class="thinking-text text-xs text-violet-600 italic inline-flex" x-ref="thinkingText">
                    <template x-for="(char, charIndex) in getStageMessage(currentStage).split('')" :key="charIndex">
                      <span x-text="char"></span>
                    </template>
                  </div>
                </div>

                <!-- Response -->
                <div x-show="!msg.isError">
                  <div
                    class="chatbot-response text-gray-900 dark:text-gray-200 text-sm leading-relaxed"
                    x-html="msg.content"
                  ></div>
                </div>

                <!-- Error Message -->
                <div x-show="msg.isError">
                  <div
                    class="chatbot-error bg-red-50 dark:bg-red-600/10 border border-red-200 dark:border-red-600/30 text-red-600 px-4 py-3 rounded-lg text-[13px]"
                    x-text="msg.content"
                  ></div>
                </div>
              </div>
            </div>
          </div>
        </template>
      </div>

      <!-- Input Container -->
      <div class="chatbot-input-container px-5 py-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 shrink-0 flex flex-col">
        <div class="chatbot-textarea-container flex flex-row gap-3 items-end relative w-full">
          <textarea
            x-ref="input"
            x-model="userInput"
            @keydown="handleKeydown($event)"
            class="flex-1 box-border px-4 py-3 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl font-inherit text-sm text-gray-900 dark:text-gray-50 resize-none min-h-[65px] h-[65px] leading-relaxed outline-none transition-[height,border-color] duration-200 overflow-y-auto focus:border-violet-600 placeholder:text-gray-400"
            placeholder="Ask about agentgateway..."
            rows="1"
          ></textarea>
          <button
            @click="toggleInputSize()"
            class="chatbot-resize-btn absolute top-2 right-[calc(48px+12px+8px)] w-7 h-7 flex items-center justify-center bg-transparent border-none text-gray-400 dark:text-gray-500 cursor-pointer z-10 pointer-events-auto hover:text-violet-600 dark:hover:text-violet-400"
            :aria-label="isInputExpanded ? 'Collapse input' : 'Expand input'"
            :title="isInputExpanded ? 'Collapse input' : 'Expand input'"
            x-html="getResizeIcon()"
          ></button>
          <button
            @click="sendQuery()"
            :disabled="isProcessing"
            class="chatbot-submit flex items-center justify-center w-12 h-12 pr-0.5 pt-0.5 pb-0 pl-0 bg-gradient-to-br from-violet-600 to-violet-700 border-none rounded-[10px] text-white cursor-pointer transition-all duration-150 shrink-0 disabled:opacity-50 disabled:cursor-not-allowed"
            aria-label="Send"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="block">
              <line x1="22" y1="2" x2="11" y2="13"></line>
              <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Markdown and Syntax Highlighting -->
<script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
<link rel="stylesheet" id="hljs-light" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
<link rel="stylesheet" id="hljs-dark" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" disabled>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<!-- Theme-aware highlight.js stylesheet switcher -->
<script>
  (function() {
    const lightLink = document.getElementById('hljs-light');
    const darkLink = document.getElementById('hljs-dark');

    function updateHighlightTheme() {
      const isDark = document.documentElement.classList.contains('dark');
      lightLink.disabled = isDark;
      darkLink.disabled = !isDark;
    }

    // Initial theme setup
    updateHighlightTheme();

    // Watch for theme changes
    const observer = new MutationObserver(updateHighlightTheme);
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['class']
    });
  })();
</script>

<!-- Bundle chatbot with Hugo Pipes (must load before Alpine) -->
{{- $opts := dict "targetPath" "js/chatbot.bundle.js" "minify" hugo.IsProduction "target" "es2015" "format" "iife" -}}
{{- $js := resources.Get "js/chatbot/index.js" | js.Build $opts | fingerprint -}}
<script src="{{ $js.RelPermalink }}"></script>

<!-- Alpine.js (loads and auto-starts after chatbot component is registered) -->
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
