<!-- Hidden mobile menu elements to prevent Hextra theme main.js errors -->
<div class="mobile-menu-overlay hx-hidden" style="display: none !important;"></div>
<div class="hamburger-menu hx-hidden" style="display: none !important;"><svg></svg></div>
<div class="sidebar-container hx-hidden" style="display: none !important;"></div>

<!-- Hide Alpine.js elements until initialized to prevent flash -->
<style>[x-cloak] { display: none !important; }</style>

<!-- Chat Bot Widget for Docs Pages -->
<div id="chatbot-widget" x-data="chatbot" @keydown.escape.window="close()">
  <!-- Trigger Button -->
  <button
    @click="toggle()"
    class="chatbot-trigger fixed bottom-6 right-6 z-[9998] flex items-center gap-2 px-5 py-3 bg-gradient-to-br from-violet-600 to-violet-700 text-white border-none rounded-full font-inherit text-sm font-medium cursor-pointer transition-all duration-200 sm:bottom-4 sm:right-4 sm:px-4 sm:py-2.5 sm:text-[13px]"
    :class="isOpen ? 'shadow-[0_2px_8px_rgba(124,58,237,0.3)] opacity-80 hover:opacity-100' : 'shadow-[0_4px_14px_rgba(124,58,237,0.4)] hover:-translate-y-0.5 hover:shadow-[0_6px_20px_rgba(124,58,237,0.5)] active:translate-y-0'"
    aria-label="Ask AI"
  >
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
    </svg>
    <span>Ask AI</span>
  </button>

  <!-- Chat Dialog (bottom-right docked widget) -->
  <div
    x-cloak
    x-show="isOpen"
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0 translate-y-4 scale-95"
    x-transition:enter-end="opacity-100 translate-y-0 scale-100"
    x-transition:leave="transition ease-in duration-150"
    x-transition:leave-start="opacity-100 translate-y-0 scale-100"
    x-transition:leave-end="opacity-0 translate-y-4 scale-95"
    :class="{ 'expanded': isExpanded }"
    class="chatbot-dialog fixed bottom-20 right-6 z-[9999] w-[min(700px,calc(100vw-3rem))] h-[50vh] max-h-[calc(100vh-8rem)] flex flex-col bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl shadow-2xl overflow-hidden transition-[height] duration-300 sm:bottom-16 sm:right-4"
  >
    <!-- Header -->
    <div class="chatbot-header flex items-center justify-between px-5 py-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 shrink-0">
      <div class="chatbot-header-title flex items-center gap-2.5 text-[15px] font-semibold text-gray-900 dark:text-gray-50">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-violet-600">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        <span>Agentgateway assistant</span>
      </div>
      <div class="flex items-center gap-1">
        <!-- New Chat Button -->
        <button
          @click="newChat()"
          class="flex items-center justify-center w-8 h-8 bg-transparent border-none rounded-lg text-gray-500 cursor-pointer transition-all duration-150 hover:bg-gray-200 hover:text-gray-900 dark:hover:bg-gray-700 dark:hover:text-gray-50"
          aria-label="New Chat"
          title="New conversation"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
        </button>
        <!-- Export Button -->
        <button
          @click="exportChat()"
          x-show="messages.length > 0"
          class="flex items-center justify-center w-8 h-8 bg-transparent border-none rounded-lg text-gray-500 cursor-pointer transition-all duration-150 hover:bg-gray-200 hover:text-gray-900 dark:hover:bg-gray-700 dark:hover:text-gray-50"
          aria-label="Export conversation"
          title="Export as Markdown"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
        </button>
        <!-- Close Button -->
        <button
          @click="isOpen = false"
          class="chatbot-minimize flex items-center justify-center w-8 h-8 bg-transparent border-none rounded-lg text-gray-500 cursor-pointer transition-all duration-150 hover:bg-gray-200 hover:text-gray-900 dark:hover:bg-gray-700 dark:hover:text-gray-50"
          aria-label="Minimize"
          title="Minimize conversation"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </button>
      </div>
    </div>

    <!-- Messages Container -->
    <div
      x-ref="messagesContainer"
      class="chatbot-messages flex-1 overflow-y-auto p-4 flex flex-col gap-5"
    >
      <!-- Welcome Message -->
      <div x-show="messages.length === 0" class="chatbot-welcome text-center py-4 px-5 text-gray-800 dark:text-gray-400 text-sm">
        <p>Ask me anything about agentgateway configuration, features, or usage.</p>
        <p>Note: AI-generated content might contain errors; please verify and test all returned information.</p>
      </div>

      <!-- Messages -->
      <template x-for="(msg, index) in messages" :key="index">
        <div :class="msg.role === 'user' ? 'flex justify-end' : 'flex justify-start'">
          <!-- User Message -->
          <div
            x-show="msg.role === 'user'"
            class="flex flex-col items-end gap-1.5 max-w-[85%]"
          >
            <div
              class="chatbot-message user bg-gradient-to-br from-violet-600 to-violet-700 text-white px-4 py-2 rounded-2xl rounded-br-sm text-sm leading-relaxed font-normal shadow-[0_2px_8px_rgba(124,58,237,0.2)] dark:shadow-[0_2px_8px_rgba(124,58,237,0.3)] break-words"
              x-text="msg.content"
            ></div>
            <!-- Context page pills for this message -->
            <div x-show="msg.contextPages && msg.contextPages.length > 0" class="flex flex-wrap gap-1 pr-1">
              <template x-for="(cp, cpIdx) in (msg.contextPages || [])" :key="cpIdx">
                <a
                  :href="cp.url"
                  class="inline-flex items-center gap-1.5 px-2 py-0.5 bg-violet-100/90 dark:bg-violet-500/20 border border-violet-300/50 dark:border-violet-500/30 text-violet-700 dark:text-violet-300 hover:bg-violet-200/90 dark:hover:bg-violet-500/30 hover:border-violet-400 dark:hover:border-violet-500/40 rounded-md text-[11px] font-medium cursor-pointer transition-colors no-underline"
                  title="Go to page"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="shrink-0">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                  </svg>
                  <span class="truncate max-w-[200px]" x-text="cp.title"></span>
                </a>
              </template>
            </div>
          </div>

          <!-- Assistant Message -->
          <div
            x-show="msg.role === 'assistant'"
            class="chatbot-message assistant flex gap-3 items-start pr-3 max-w-[90%]"
          >
            <!-- Avatar -->
            <div
              :class="{ 'loading': msg.isLoading }"
              class="chatbot-avatar shrink-0 w-8 h-8 flex items-center justify-center rounded-lg p-1 relative"
            >
              <img src="/favicon.svg" alt="Agent" class="w-full h-full transition-all duration-200">
            </div>

            <!-- Content -->
            <div class="chatbot-message-content flex-1 min-w-0 max-w-[90%]">
              <!-- Thinking Indicator -->
              <div
                x-show="msg.isStreaming && showThinking && isLastMessage(index)"
                class="chatbot-thinking mb-1"
              >
                <div class="thinking-dots inline-flex gap-1" x-ref="thinkingDots">
                  <span class="dot">•</span>
                  <span class="dot">•</span>
                  <span class="dot">•</span>
                </div>
              </div>

              <!-- Response -->
              <div x-show="!msg.isError">
                <div
                  class="chatbot-response text-gray-900 dark:text-gray-200 text-sm leading-relaxed"
                  x-html="msg.content"
                ></div>
              </div>

              <!-- Error Message -->
              <div x-show="msg.isError">
                <!-- Rate Limit Error -->
                <div
                  x-show="msg.isRateLimited"
                  class="chatbot-error chatbot-error-rate-limit bg-amber-50 dark:bg-amber-600/10 border border-amber-200 dark:border-amber-600/30 text-amber-700 dark:text-amber-400 px-4 py-3 rounded-lg text-[13px] flex items-start gap-3"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="shrink-0 mt-0.5">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                  </svg>
                  <div>
                    <div class="font-medium mb-1">Rate limit reached</div>
                    <div class="text-amber-600 dark:text-amber-300/80" x-text="msg.content"></div>
                  </div>
                </div>
                <!-- Generic Error -->
                <div
                  x-show="!msg.isRateLimited"
                  class="chatbot-error bg-red-50 dark:bg-red-600/10 border border-red-200 dark:border-red-600/30 text-red-600 px-4 py-3 rounded-lg text-[13px]"
                  x-text="msg.content"
                ></div>
              </div>

              <!-- Feedback (thumb up / thumb down) -->
              <div
                x-show="!msg.isError && !msg.isStreaming && msg.content"
                class="flex items-center gap-0.5 mt-1.5 -ml-1"
              >
                <!-- Thumb up -->
                <button
                  @click="submitFeedback(index, 'up')"
                  :disabled="!!msg.feedback"
                  :class="{
                    'text-green-500 dark:text-green-400': msg.feedback === 'up',
                    'text-gray-300 dark:text-gray-600 hover:text-gray-500 dark:hover:text-gray-400': !msg.feedback,
                    'text-gray-200 dark:text-gray-700': msg.feedback && msg.feedback !== 'up'
                  }"
                  class="p-1 bg-transparent border-none rounded transition-colors duration-150"
                  :style="msg.feedback && msg.feedback !== 'up' ? 'cursor:default' : 'cursor:pointer'"
                  aria-label="Thumbs up"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path>
                  </svg>
                </button>
                <!-- Thumb down -->
                <button
                  @click="submitFeedback(index, 'down')"
                  :disabled="!!msg.feedback"
                  :class="{
                    'text-red-500 dark:text-red-400': msg.feedback === 'down',
                    'text-gray-300 dark:text-gray-600 hover:text-gray-500 dark:hover:text-gray-400': !msg.feedback,
                    'text-gray-200 dark:text-gray-700': msg.feedback && msg.feedback !== 'down'
                  }"
                  class="p-1 bg-transparent border-none rounded transition-colors duration-150"
                  :style="msg.feedback && msg.feedback !== 'down' ? 'cursor:default' : 'cursor:pointer'"
                  aria-label="Thumbs down"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      </template>
    </div>

    <!-- Input Container -->
    <div class="chatbot-input-container px-4 py-3 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 shrink-0">
      <!-- Unified input card -->
      <div class="chatbot-input-card bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl transition-colors duration-150 focus-within:border-violet-500 focus-within:ring-2 focus-within:ring-violet-500/20">

        <!-- Context page pills (shown when pages are added) -->
        <div x-show="contextPages.length > 0" x-transition.duration.150ms class="px-3 pt-2.5 pb-0 flex flex-wrap gap-1.5">
          <template x-for="(page, pageIdx) in contextPages" :key="page.url">
            <span
              :class="pageIdx < 3 ? 'bg-violet-50 dark:bg-violet-500/10 border-violet-200 dark:border-violet-500/20 text-violet-700 dark:text-violet-300' : 'bg-red-50 dark:bg-red-500/10 border-red-200 dark:border-red-500/20 text-red-600 dark:text-red-400'"
              :title="pageIdx >= 3 ? 'Exceeds the 3-page limit — this page will not be sent as context.' : ''"
              class="inline-flex items-center gap-1.5 max-w-full px-2 py-1 border rounded-lg text-xs font-medium"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="shrink-0">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
              </svg>
              <span class="truncate max-w-[150px]" x-text="page.title"></span>
              <button
                @click="removeContextPage(pageIdx)"
                :class="pageIdx < 3 ? 'text-violet-400 hover:text-violet-700 dark:hover:text-violet-200' : 'text-red-400 hover:text-red-700 dark:hover:text-red-200'"
                class="shrink-0 ml-0.5 p-0 bg-transparent border-none cursor-pointer transition-colors"
                aria-label="Remove page context"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
            </span>
          </template>
        </div>

        <!-- @ Mention autocomplete popup -->
        <div class="relative">
          <div
            x-show="showMentionMenu && filteredMentionPages.length > 0"
            x-transition:enter="transition ease-out duration-100"
            x-transition:enter-start="opacity-0 -translate-y-1"
            x-transition:enter-end="opacity-100 translate-y-0"
            x-transition:leave="transition ease-in duration-75"
            x-transition:leave-start="opacity-100 translate-y-0"
            x-transition:leave-end="opacity-0 -translate-y-1"
            class="chatbot-mention-menu absolute bottom-full left-0 right-0 mb-1 mx-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-lg z-20 overflow-hidden"
          >
            <div x-ref="mentionList" class="chatbot-mention-list max-h-[240px] overflow-y-auto py-1">
              <template x-for="(page, mIdx) in filteredMentionPages" :key="page._isCurrentPage ? '__current__' : page.url">
                <button
                  @click="selectMention(page)"
                  @mouseenter="mentionSelectedIndex = mIdx"
                  :class="mIdx === mentionSelectedIndex ? 'bg-violet-50 dark:bg-violet-500/10 text-violet-700 dark:text-violet-300' : 'text-gray-700 dark:text-gray-200'"
                  class="chatbot-mention-item w-full flex flex-col gap-0.5 px-3 py-2 text-left bg-transparent border-none cursor-pointer text-sm hover:bg-violet-50 dark:hover:bg-violet-500/10 transition-colors"
                >
                  <div class="flex items-center gap-1.5">
                    <span class="font-medium truncate" x-text="page.title"></span>
                    <span
                      x-show="page._isCurrentPage"
                      class="shrink-0 px-1.5 py-0.5 rounded text-[10px] font-medium bg-violet-100 dark:bg-violet-500/20 text-violet-600 dark:text-violet-400"
                    >Current page</span>
                  </div>
                  <span class="text-[11px] text-gray-400 dark:text-gray-500 truncate" x-text="page.section ? page.section + ' — ' + page.url : page.url"></span>
                </button>
              </template>
            </div>
            <div class="px-3 py-1.5 border-t border-gray-100 dark:border-gray-700 text-[11px] text-gray-400 dark:text-gray-500 flex items-center gap-2">
              <span class="px-1 py-0.5 bg-gray-100 dark:bg-gray-700 rounded text-[10px] font-mono">↑↓</span> navigate
              <span class="px-1 py-0.5 bg-gray-100 dark:bg-gray-700 rounded text-[10px] font-mono">↵</span> select
              <span class="px-1 py-0.5 bg-gray-100 dark:bg-gray-700 rounded text-[10px] font-mono">esc</span> dismiss
            </div>
          </div>
        </div>

        <!-- Textarea -->
        <textarea
          x-ref="input"
          x-model="userInput"
          @keydown="handleKeydown($event)"
          @paste="handlePaste($event)"
          @drop="handleDrop($event)"
          @dragover="handleDragOver($event)"
          class="w-full box-border px-3 py-2.5 bg-transparent border-none font-inherit text-sm text-gray-900 dark:text-gray-50 resize-none leading-relaxed outline-none overflow-y-auto placeholder:text-gray-400"
          style="height: 68px"
          placeholder="Ask about agentgateway... (type @ to mention a page, paste/drag links here)"
          rows="1"
        ></textarea>

        <!-- Bottom toolbar -->
        <div class="flex items-center justify-between px-1.5 pb-1.5">

          <!-- Left: + context menu -->
          <div class="relative">
            <button
              @click="showContextMenu = !showContextMenu"
              :class="contextPages.length > 0 ? 'text-violet-600 dark:text-violet-400 bg-violet-50 dark:bg-violet-500/10' : 'text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'"
              class="flex items-center justify-center w-8 h-8 bg-transparent border-none rounded-lg cursor-pointer transition-all duration-150"
              aria-label="Add context"
              title="Add context"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>

            <!-- Context dropdown menu -->
            <div
              x-show="showContextMenu"
              x-transition:enter="transition ease-out duration-100"
              x-transition:enter-start="opacity-0 scale-95"
              x-transition:enter-end="opacity-100 scale-100"
              x-transition:leave="transition ease-in duration-75"
              x-transition:leave-start="opacity-100 scale-100"
              x-transition:leave-end="opacity-0 scale-95"
              @click.outside="showContextMenu = false"
              class="absolute bottom-full left-0 mb-1.5 w-56 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-lg py-1.5 z-10"
            >
              <!-- Add this page button -->
              <button
                @click="() => { addCurrentPage(); showContextMenu = false; }"
                class="w-full flex items-center gap-3 px-3 py-2 text-left bg-transparent border-none cursor-pointer text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="shrink-0 text-gray-400 dark:text-gray-500">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                </svg>
                <span class="flex-1">Add this page</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="shrink-0 text-gray-400 dark:text-gray-500">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
              </button>
              <!-- Mention a page -->
              <button
                @click="insertMention(); showContextMenu = false"
                class="w-full flex items-center gap-3 px-3 py-2 text-left bg-transparent border-none cursor-pointer text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="shrink-0 text-gray-400 dark:text-gray-500">
                  <circle cx="12" cy="12" r="4"></circle>
                  <path d="M16 8v5a3 3 0 0 0 6 0v-1a10 10 0 1 0-3.92 7.94"></path>
                </svg>
                <span class="flex-1">Mention a page</span>
                <span class="text-[11px] text-gray-400 dark:text-gray-500 font-mono">@</span>
              </button>
            </div>
          </div>

          <!-- Right: model selector + send -->
          <div class="flex items-center gap-1">

            <!-- Custom model selector -->
            <div class="relative">
              <button
                @click="showModelMenu = !showModelMenu"
                class="flex items-center gap-1 px-2 py-1.5 bg-transparent border-none rounded-lg text-xs font-medium text-gray-500 dark:text-gray-400 cursor-pointer hover:text-gray-700 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
              >
                <span x-text="getModelLabel()"></span>
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-50">
                  <path d="M6 9l6 6 6-6"></path>
                </svg>
              </button>

              <!-- Model dropdown menu -->
              <div
                x-show="showModelMenu"
                x-transition:enter="transition ease-out duration-100"
                x-transition:enter-start="opacity-0 scale-95"
                x-transition:enter-end="opacity-100 scale-100"
                x-transition:leave="transition ease-in duration-75"
                x-transition:leave-start="opacity-100 scale-100"
                x-transition:leave-end="opacity-0 scale-95"
                @click.outside="showModelMenu = false"
                class="absolute bottom-full right-0 mb-1.5 w-52 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-lg py-1.5 z-10"
              >
                <button
                  @click="selectedModel = 'standalone'; showModelMenu = false; saveState()"
                  class="w-full flex items-center justify-between px-3 py-2 text-left bg-transparent border-none cursor-pointer text-sm hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors"
                  :class="selectedModel === 'standalone' ? 'text-gray-900 dark:text-gray-50 font-medium' : 'text-gray-600 dark:text-gray-300'"
                >
                  <div>
                    <div>Standalone</div>
                    <div class="text-[11px] text-gray-400 dark:text-gray-500 font-normal">Standalone deployment docs</div>
                  </div>
                  <svg x-show="selectedModel === 'standalone'" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-violet-600 shrink-0">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                </button>
                <button
                  @click="selectedModel = 'kubernetes'; showModelMenu = false; saveState()"
                  class="w-full flex items-center justify-between px-3 py-2 text-left bg-transparent border-none cursor-pointer text-sm hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors"
                  :class="selectedModel === 'kubernetes' ? 'text-gray-900 dark:text-gray-50 font-medium' : 'text-gray-600 dark:text-gray-300'"
                >
                  <div>
                    <div>Kubernetes</div>
                    <div class="text-[11px] text-gray-400 dark:text-gray-500 font-normal">Kubernetes deployment docs</div>
                  </div>
                  <svg x-show="selectedModel === 'kubernetes'" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-violet-600 shrink-0">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                </button>
              </div>
            </div>

            <!-- Send button -->
            <button
              @click="sendQuery()"
              :disabled="isProcessing || !userInput.trim()"
              class="chatbot-submit flex items-center justify-center w-8 h-8 border-none rounded-lg cursor-pointer transition-all duration-150 active:scale-95 disabled:opacity-30 disabled:cursor-not-allowed"
              :class="userInput.trim() && !isProcessing ? 'bg-violet-600 text-white hover:bg-violet-500 shadow-sm' : 'bg-transparent text-gray-300 dark:text-gray-600'"
              aria-label="Send"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Feedback Comment Modal (thumb-down follow-up) -->
    <div
      x-cloak
      x-show="showFeedbackModal"
      x-transition:enter="transition ease-out duration-150"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition ease-in duration-100"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
      @click="closeFeedbackModal()"
      class="absolute inset-0 z-50 flex items-center justify-center bg-black/30 dark:bg-black/50 rounded-2xl"
    >
      <div
        x-show="showFeedbackModal"
        x-transition:enter="transition ease-out duration-150 delay-75"
        x-transition:enter-start="opacity-0 scale-95 translate-y-2"
        x-transition:enter-end="opacity-100 scale-100 translate-y-0"
        x-transition:leave="transition ease-in duration-100"
        x-transition:leave-start="opacity-100 scale-100 translate-y-0"
        x-transition:leave-end="opacity-0 scale-95 translate-y-2"
        @click.stop
        class="w-[min(400px,calc(100%-2rem))] bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-xl p-5"
      >
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-semibold text-gray-900 dark:text-gray-50 m-0">What could be improved?</h3>
          <button
            @click="closeFeedbackModal()"
            class="flex items-center justify-center w-6 h-6 bg-transparent border-none rounded text-gray-400 cursor-pointer hover:text-gray-600 dark:hover:text-gray-300 transition-colors"
            aria-label="Close"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <textarea
          x-ref="feedbackInput"
          x-model="feedbackComment"
          @keydown.escape.stop="closeFeedbackModal()"
          class="w-full box-border px-3 py-2 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg text-sm text-gray-900 dark:text-gray-50 resize-none outline-none focus:border-violet-500 focus:ring-2 focus:ring-violet-500/20 transition-colors font-inherit"
          rows="3"
          placeholder="Tell us what went wrong (optional)..."
        ></textarea>
        <div class="flex items-center justify-end gap-2 mt-3">
          <button
            @click="closeFeedbackModal()"
            class="px-3 py-1.5 bg-transparent border border-gray-200 dark:border-gray-600 rounded-lg text-sm text-gray-600 dark:text-gray-400 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors font-inherit"
          >Skip</button>
          <button
            @click="submitFeedbackComment()"
            :disabled="!feedbackComment.trim()"
            class="px-3 py-1.5 bg-violet-600 border-none rounded-lg text-sm text-white cursor-pointer hover:bg-violet-500 transition-colors disabled:opacity-40 disabled:cursor-not-allowed font-inherit"
          >Submit</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Markdown and Syntax Highlighting -->
<script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
<link rel="stylesheet" id="hljs-light" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
<link rel="stylesheet" id="hljs-dark" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" disabled>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<!-- Theme-aware highlight.js stylesheet switcher -->
<script>
  (function() {
    const lightLink = document.getElementById('hljs-light');
    const darkLink = document.getElementById('hljs-dark');

    function updateHighlightTheme() {
      const isDark = document.documentElement.classList.contains('dark');
      lightLink.disabled = isDark;
      darkLink.disabled = !isDark;
    }

    // Initial theme setup
    updateHighlightTheme();

    // Watch for theme changes
    const observer = new MutationObserver(updateHighlightTheme);
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['class']
    });
  })();
</script>

<!-- Page index for @ mention autocomplete (built by Hugo at compile time) -->
<script id="chatbot-page-index" type="application/json">
{{- $pages := slice -}}
{{- range where .Site.RegularPages "Section" "docs" -}}
  {{- $parentTitle := "" -}}
  {{- with .Parent -}}
    {{- $parentTitle = .Title -}}
  {{- end -}}
  {{- $pages = $pages | append (dict "title" .Title "url" .RelPermalink "section" $parentTitle) -}}
{{- end -}}
{{ $pages | jsonify | safeJS }}
</script>

<!-- Bundle chatbot with Hugo Pipes (must load before Alpine) -->
{{- $opts := dict "targetPath" "js/chatbot.bundle.js" "minify" hugo.IsProduction "target" "es2015" "format" "iife" -}}
{{- $js := resources.Get "js/chatbot/index.js" | js.Build $opts | fingerprint -}}
<script src="{{ $js.RelPermalink }}"></script>

<!-- Alpine.js (loads and auto-starts after chatbot component is registered) -->
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
